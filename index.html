<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Emoji Countdown</title>
    <style type="text/css">
    @font-face {
        font-family: 'digital';
        src: url('fonts/digital.ttf');
    }
    
    @font-face {
        font-family: 'poppins';
        src: url('fonts/Poppins-Light.ttf');
        font-weight: lighter;
        font-style: normal;
    }
    
    @font-face {
        font-family: 'poppins';
        src: url('fonts/Poppins-Bold.ttf');
        font-weight: bold;
        font-style: normal;
    }
    
    @font-face {
        font-family: 'poppins';
        src: url('fonts/Poppins-Regular.ttf');
        font-weight: normal;
        font-style: normal;
    }
    
    @keyframes wiggle {
        from {
            margin-top: 30px;
        }
        to {
            margin-top: 0px;
        }
    }
    
    @keyframes rotate {
        from {
            width: 90%;
            margin-top: 30px;
            transform: rotateY(30deg);
        }
        to {
            margin-top: 0px;
        }
    }
    
    @keyframes blink {
        from {
            opacity: 0.2;
        }
        to {
            opacity: 1;
        }
    }
    
    .green {
        color: green;
    }
    
    .orange {
        color: orange;
    }
    
    .red {
        color: red;
    }
    
    .red-danger {
        color: red;
    }
    
    .red-dead {
        color: red;
    }
    
    #container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 24em;
    }
    
    #timer {
        font-family: 'digital';
        text-align: center;
        padding: 20px;
        font-size: 200px;
        margin-bottom: 40px;
    }
    
    #svg {
        height: 400px;
        animation: wiggle 1s ease-in-out 0s infinite alternate;
    }
    
    .overlay {
        height: 100vh;
        width: 100%;
        position: absolute;
        z-index: -10;
        /*background-image: url('image.jpg');*/
        -webkit-filter: blur(15px);
        -moz-filter: blur(15px);
        -o-filter: blur(15px);
        -ms-filter: blur(15px);
        filter: blur(15px);
    }
    
    html,
    body,
    .overlay {
        padding: 0;
        margin: 0;
    }
    </style>
    <link rel="stylesheet" href="morris.css">
</head>

<body>
    <style type="text/css">
    .stats {
        height: 100vh;
        width: 100%;
    }
    
    .today,
    #chart {
        float: left;
        width: 100%;
        text-align: center;
        filter: none !important;
        font-family: 'poppins';
    }
    
    .clearfix {
        float: none;
        clear: both;
    }
    
    .today {
        font-size: 80px;
        height:40%;
    }
    
    #chart {
        padding: 0;
        margin: 0;
        height: 60%;
    }
    
    .col {
        width: 25%;
        float: left;
        text-align: center;
    }
    
    .number {
        font-weight: bold;
    }
    
    .title {
        font-weight: 100;
        margin-top:-16%;
    }
    
    .overlay,
    .stats {
        display: none;
    }
    </style>
    <div class="overlay">
    </div>
    <div class="stats">
        <div class="today">
            <div class="col">
                <div class="number today-total">0</div>
                <div class="title">TOTAL</div>
            </div>
            <div class="col">
                <div class="number today-avg">0</div>
                <div class="title">AVG</div>
            </div>
            <div class="col">
                <div class="number today-max">0</div>
                <div class="title">HIGHEST</div>
            </div>
            <div class="col">
                <div class="number today-min">0</div>
                <div class="title">LOWEST</div>
            </div>
        </div>
        <div id="chart">
            <div class="avg-time">
                <span class="title">AVG sME:</span>
                <span class="today-total">30.26</span>
            </div>
        </div>
    </div>
    <div class="clearfix"></div>
    <div id="container">
        <div class="emoji">
            <div id="timer">00</div>
            <img id="svg" src="svg/1f634.svg" />
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="db.js"></script>
    <script src="raphael-min.js"></script>
    <script src="morris.min.js"></script>
    <script type="text/javascript">
    var clickCounter = 0;
    var dullTime = 15;
    var allowedTime = 30;
    var warningTimeStart = 45;
    var deadTime = 60;
    var addedEntry = false;
    var pauseTimer = false;
    $('body').keypress(function() {
        clickCounter++;
        if (clickCounter > 2) {
            clickCounter = 0;
        }
    });
    $('body').dblclick(function() {
        if (!$('.overlay').is(':visible')) {
            $('.overlay,.stats').fadeIn();
            showStats();
            pauseTimer = true;
        } else {
            $('.overlay,.stats').fadeOut();
            pauseTimer = false;
            clickCounter = 2;

        }

    })
    showStats = function() {
        getTimingForAday('now').then(function(result) {
            if (!result || !result.length)
                return;
            result = Array.from(result);
            var timings = result.map(e => e.timing)
            var min = Math.min(...timings)
            var max = Math.max(...timings)
            var total = timings.reduce((e, b) => e + b, 0)
            var avg = (total / timings.length);
            if (avg % 1 !== 0) {
                avg = avg.toFixed(2);
            }
            updateStat({
                min,
                max,
                total,
                avg
            })


        });
    }

    function updateStat(stats) {
        $('.today-total').html(stats.total)
        $('.today-min').html(stats.min)
        $('.today-max').html(stats.max)
        $('.today-avg').html(stats.avg)
        animateNumber();
        drawChart();
    }

    function drawChart() {
        $('#chart').html('')
        Morris.Area({
            element: 'chart',
            data: [{
                y: '2006',
                a: 100,
                b: 90
            }, {
                y: '2007',
                a: 75,
                b: 65
            }, {
                y: '2008',
                a: 50,
                b: 40
            }, {
                y: '2009',
                a: 75,
                b: 65
            }, {
                y: '2010',
                a: 50,
                b: 40
            }, {
                y: '2011',
                a: 75,
                b: 65
            }, {
                y: '2012',
                a: 100,
                b: 90
            }],
            xkey: 'y',
            ykeys: ['a', 'b'],
            labels: ['Series A', 'Series B'],
            lineColors: ["rgba(155,215,215,0.2)", "rgba(121,215,255,0.1)"]
        })
    }

    function min(a, b, c) {
        debugger;
    }
    var counter = window.setInterval(function() {
        if (pauseTimer) {
            return
        }
        if (clickCounter == 1) {
            // $('#svg').attr("style", "animation:none;");
            if (!addedEntry) {
                addTiming(parseInt($('#timer').html()))
                addedEntry = !addedEntry;
            }
            return;
        }
        if (clickCounter == 2) {
            var number = 0;
            $('#timer').attr("style", "");
            $('#svg').attr("style", "");
            clickCounter = 0;
            addedEntry = !addedEntry;
        } else {
            var number = parseInt($('#timer').html()) + 1;
            $('#svg').attr("style", "");
        }
        addClass(number);
        $('#timer').html(pad(number, 2));
    }, 1000);
    var addClass = function(number) {
        var cls = "dull-time";
        if (number > deadTime) {
            cls = "red-dead";
            $('#svg').attr("style", "animation-name:blink;animation-duration:0.5s");
            $('#timer').attr("style", "animation:blink 0.5s ease-in-out 0s infinite alternate");
        } else if (number == deadTime) {
            var audio = new Audio('sound/end.mp3');
            audio.play();
            cls = "red-danger";
            $('#svg').attr("style", "animation-name:rotate;animation-duration:1s");
        } else if (number > warningTimeStart) {
            cls = "red";
            $('#svg').attr("style", "animation-duration:0.1s");
        } else if (number > allowedTime) {
            cls = "orange";
        } else if (number > dullTime) {
            cls = "green";
        }

        $('#timer').attr('class', cls);
        changeEmoji(cls);
    };
    var changeEmoji = function(color) {
        var emojis = {
            green: '1f603',
            orange: '1f62e',
            red: '1f922',
            'red-danger': '1f4a5',
            'red-dead': '1f47a',
            'dull-time': '1f634'
        };
        var expectedEmojiURL = 'svg/' + emojis[color] + '.svg';
        var currentEmojiURL = $('#svg').attr('src');
        if (expectedEmojiURL != currentEmojiURL) {
            $('#svg').attr('src', expectedEmojiURL);
        }
    }

    function animateNumber() {
        $('.number').each(function() {
            $(this).prop('Counter', 0).animate({
                Counter: $(this).text().replace(/,/g, '')
            }, {
                duration: 1000,
                easing: 'swing',
                step: function(now) {
                    $(this).text(Math.ceil(now));
                }
            });
        });
    }

    function pad(n, width, z) {
        z = z || '0';
        n = n + '';
        return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
    }
    </script>
</body>

</html>
